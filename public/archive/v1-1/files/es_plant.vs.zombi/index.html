<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Alparka!</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="favicon.png" sizes="32x32" />
  </head>
  <body>
    <div id="gameContainer">
      <h2>ì•Œì•„ì„œ ë§Œë“¤ì–´ ì£¼ëŠ” AI ë†€ì´ê³µì›, Alparka!</h2>
      <canvas id="gameCanvas" width="1080" height="720"></canvas>
    </div>
    <script defer>
      const SERVER_URL = "http://localhost:8000/client-error";

      // ğŸŒŸ 1. ì›ë˜ í•¨ìˆ˜ë“¤ì„ ì „ì—­ì ìœ¼ë¡œ ë°±ì—…
      const originalConsoleLog = window.console.log;
      const originalConsoleError = window.console.error;
      const originalConsoleWarn = window.console.warn;

      // ğŸ”¥ 2. ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ ì—ëŸ¬ ìºì‹œ (í•´ì‹œë§µ)
      const errorCache = new Map();
      const ERROR_CACHE_LIMIT = 100; // ìµœëŒ€ ìºì‹œ ê°œìˆ˜
      const ERROR_DEDUPE_WINDOW = 5000; // 5ì´ˆ ë‚´ ë™ì¼ ì—ëŸ¬ëŠ” ë¬´ì‹œ

      // ğŸ”¥ ì¶”ê°€: ì´ˆê³ ì† ì—ëŸ¬ í­ì£¼ ë°©ì–´ (Circuit Breaker)
      let errorCount = 0;
      let errorCountResetTimer = null;
      const MAX_ERRORS_PER_SECOND = 50; // ì´ˆë‹¹ ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ ì²˜ë¦¬

      function isErrorFlood() {
        errorCount++;

        // íƒ€ì´ë¨¸ ì´ˆê¸°í™”
        if (errorCountResetTimer) {
          clearTimeout(errorCountResetTimer);
        }

        errorCountResetTimer = setTimeout(() => {
          errorCount = 0;
        }, 1000);

        // ì„ê³„ê°’ ì´ˆê³¼ ì‹œ ì°¨ë‹¨
        if (errorCount > MAX_ERRORS_PER_SECOND) {
          if (errorCount === MAX_ERRORS_PER_SECOND + 1) {
            originalConsoleError.call(
              window.console,
              "ğŸš¨ ì—ëŸ¬ í­ì£¼ ê°ì§€! ì¼ë¶€ ì—ëŸ¬ ë¬´ì‹œ ì¤‘..."
            );
          }
          return true;
        }

        return false;
      }

      // ğŸ”¥ 3. ì—ëŸ¬ ê³ ìœ  í‚¤ ìƒì„± í•¨ìˆ˜
      function getErrorKey(errorData) {
        const { type, message, source, lineno, colno, stack } = errorData;

        // ì˜µì…˜ 1: ê¸°ë³¸ - ê°™ì€ ìœ„ì¹˜ + ê°™ì€ ë©”ì‹œì§€ = ë™ì¼ ì—ëŸ¬
        // return `${type}:${message}:${source || ''}:${lineno || ''}:${colno || ''}`;

        // ì˜µì…˜ 2: ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ í¬í•¨ - ë” ì •í™•í•œ ì‹ë³„
        // (ìŠ¤íƒì˜ ì²« 3ì¤„ë§Œ ì‚¬ìš©í•´ì„œ í‚¤ ê¸¸ì´ ì œí•œ)
        const stackHash =
          stack && stack !== "N/A"
            ? stack.split("\n").slice(0, 3).join("|")
            : "";
        return `${type}:${message}:${stackHash}`;

        // ì˜µì…˜ 3: ì™„ì „íˆ ëª¨ë“  ì—ëŸ¬ ì „ì†¡ (ì¤‘ë³µ ì œê±° ì•ˆí•¨)
        // return `${type}:${message}:${Date.now()}:${Math.random()}`;
      }

      // ğŸ”¥ 4. ì¤‘ë³µ ì²´í¬ í•¨ìˆ˜ (Race condition ë°©ì§€)
      function isDuplicateError(errorData) {
        const key = getErrorKey(errorData);

        // âš¡ ì¦‰ì‹œ ìºì‹œ í™•ì¸ ë° ë“±ë¡ (ì›ìì  ì—°ì‚°)
        if (errorCache.has(key)) {
          return true; // ì¤‘ë³µ!
        }

        // ğŸ”¥ ì¦‰ì‹œ ìºì‹œì— ë“±ë¡ (ë‹¤ìŒ ì—ëŸ¬ê°€ ì˜¤ê¸° ì „ì—!)
        errorCache.set(key, true);

        // ìºì‹œ í¬ê¸° ì œí•œ (ì˜¤ë˜ëœ í•­ëª© ì‚­ì œ)
        if (errorCache.size > ERROR_CACHE_LIMIT) {
          const firstKey = errorCache.keys().next().value;
          errorCache.delete(firstKey);
        }

        return false;
      }

      // ê³µí†µ ì „ì†¡ + ì½˜ì†” ì¶œë ¥ í•¨ìˆ˜
      function sendError(data) {
        // ğŸ”¥ 1ë‹¨ê³„: ì—ëŸ¬ í­ì£¼ ì²´í¬ (Circuit Breaker)
        if (isErrorFlood()) {
          return; // ì´ˆë‹¹ 50ê°œ ì´ˆê³¼ ì‹œ ë¬´ì‹œ
        }

        // ğŸ”¥ 2ë‹¨ê³„: ì¤‘ë³µ ì²´í¬ë¥¼ ë§¨ ë¨¼ì € ì‹¤í–‰ (ë‹¤ë¥¸ ì‘ì—…ë³´ë‹¤ ìš°ì„ )
        if (isDuplicateError(data)) {
          originalConsoleLog.call(
            window.console,
            "%cğŸ”„ ì¤‘ë³µ ì—ëŸ¬ ë¬´ì‹œ",
            "color: gray; font-style: italic;",
            data.type,
            data.message
          );
          return; // ì¦‰ì‹œ ì¢…ë£Œ
        }

        // ì´ì œ ì•ˆì „í•˜ê²Œ ë‚˜ë¨¸ì§€ ì‘ì—… ìˆ˜í–‰
        data.game_version = "1.0.1";
        data.time = new Date().toISOString();

        // ë¶€ëª¨ í˜ì´ì§€ë¡œ ì˜¤ë¥˜ ë°ì´í„° ì „ë‹¬ (postMessage)
        try {
          window.parent.postMessage(
            {
              source: "alparka-game-iframe",
              type: "error-report",
              payload: data,
            },
            "*"
          );
        } catch (e) {
          originalConsoleWarn.call(
            window.console,
            "ğŸš¨ ë¶€ëª¨ ì°½ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:",
            e
          );
        }

        // íƒ€ì…ë³„ ì½˜ì†” ì¶œë ¥
        switch (data.type) {
          case "console-error":
            originalConsoleError.call(
              window.console,
              "%cğŸ“¥ ì½˜ì†” ì—ëŸ¬",
              "color: green; font-weight: bold;",
              data
            );
            break;
          case "console-warn":
            originalConsoleWarn.call(
              window.console,
              "%câš ï¸ ì½˜ì†” ê²½ê³ ",
              "color: orange; font-weight: bold;",
              data
            );
            break;
          case "page-load":
            originalConsoleLog.call(
              window.console,
              "%cğŸ“¥ í˜ì´ì§€ ì ‘ì† ì™„ë£Œ",
              "color: green; font-weight: bold;",
              data
            );
            break;
          case "js-error":
            originalConsoleError.call(
              window.console,
              "%cğŸ’¥ JS ëŸ°íƒ€ì„ ì—ëŸ¬",
              "color: red; font-weight: bold;",
              data
            );
            break;
          case "unhandledrejection":
            originalConsoleError.call(
              window.console,
              "%câš ï¸ Promise ë¹„ë™ê¸° ì—ëŸ¬",
              "color: orange; font-weight: bold;",
              data
            );
            break;
          case "resource-error":
            originalConsoleWarn.call(
              window.console,
              "%cğŸ–¼ï¸ ë¦¬ì†ŒìŠ¤ ë¡œë“œ ì‹¤íŒ¨",
              "color: purple; font-weight: bold;",
              data
            );
            break;
          case "fetch-failed":
            originalConsoleError.call(
              window.console,
              "%cğŸ“¡ ì„œë²„ ì „ì†¡ ì‹¤íŒ¨",
              "color: darkred; font-weight: bold;",
              data
            );
            break;
          case "media-error":
            originalConsoleError.call(
              window.console,
              "%cğŸ”Š ë¯¸ë””ì–´ ì¬ìƒ ì‹¤íŒ¨",
              "color: darkorange; font-weight: bold;",
              data
            );
            break;
          case "game-loop-error":
            originalConsoleError.call(
              window.console,
              "%cğŸ® ê²Œì„ ë£¨í”„ ì—ëŸ¬",
              "color: crimson; font-weight: bold;",
              data
            );
            break;
          default:
            originalConsoleLog.call(
              window.console,
              "%câ„¹ï¸ ê¸°íƒ€ ì´ë²¤íŠ¸",
              "color: blue;",
              data
            );
            break;
        }

        // ì„œë²„ ì „ì†¡
        fetch(SERVER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        }).catch((err) => {
          originalConsoleError.call(
            window.console,
            "âŒ ì„œë²„ ì „ì†¡ ì‹¤íŒ¨ (fetch catch):",
            err
          );
          const failData = {
            type: "fetch-failed",
            original: data,
            reason: err.message,
          };
          originalConsoleLog.call(
            window.console,
            "ğŸ“¡ fetch ì‹¤íŒ¨ ë¡œê·¸:",
            failData
          );
        });
      }

      // ğŸ”¥ 1ï¸âƒ£ JS ëŸ°íƒ€ì„ ì—ëŸ¬ (window.onerror)
      window.onerror = function (message, source, lineno, colno, error) {
        sendError({
          type: "js-error",
          message: String(message),
          source: source || "unknown",
          lineno: lineno || 0,
          colno: colno || 0,
          stack: error ? error.stack : "N/A",
        });
        return false; // ë¸Œë¼ìš°ì € ê¸°ë³¸ ì—ëŸ¬ ì²˜ë¦¬ë„ ì‹¤í–‰
      };

      // ğŸ”¥ 2ï¸âƒ£ Promise rejection ì—ëŸ¬ (unhandledrejection)
      window.addEventListener("unhandledrejection", function (event) {
        sendError({
          type: "unhandledrejection",
          message: event.reason ? String(event.reason) : "Promise rejected",
          source: "promise",
          lineno: 0,
          colno: 0,
          stack:
            event.reason && event.reason.stack ? event.reason.stack : "N/A",
        });
      });

      // ğŸ”¥ 3ï¸âƒ£ ë¦¬ì†ŒìŠ¤ ë¡œë“œ ì—ëŸ¬ (error ì´ë²¤íŠ¸ ìº¡ì²˜)
      window.addEventListener(
        "error",
        function (event) {
          if (event.target !== window) {
            // img, script, link ë“±ì˜ ë¦¬ì†ŒìŠ¤ ë¡œë“œ ì‹¤íŒ¨
            sendError({
              type: "resource-error",
              message: `Failed to load: ${event.target.tagName}`,
              source: event.target.src || event.target.href || "unknown",
              lineno: 0,
              colno: 0,
              stack: "N/A",
            });
          }
        },
        true // ìº¡ì²˜ ë‹¨ê³„ì—ì„œ ì´ë²¤íŠ¸ ê°ì§€
      );

      // ğŸ”¥ 4ï¸âƒ£ console.error ì˜¤ë²„ë¼ì´ë“œ
      window.console.error = function (...args) {
        originalConsoleError.apply(window.console, args);

        const message = args
          .map((arg) => {
            if (typeof arg === "object" && arg !== null) {
              try {
                return JSON.stringify(arg);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");

        sendError({
          type: "console-error",
          message: message,
          source: "console.error",
          lineno: 0,
          colno: 0,
          detail: args.length > 0 ? args[0] : null,
        });
      };

      // ğŸ”¥ 5ï¸âƒ£ console.warn ì˜¤ë²„ë¼ì´ë“œ (ì„ íƒì‚¬í•­)
      // ğŸ’¡ warnì€ ì½”ë“œ ì‹¤í–‰ì— ì¹˜ëª…ì ì´ì§€ ì•Šìœ¼ë¯€ë¡œ í•„ìš”ì‹œì—ë§Œ í™œì„±í™”
      // ê°œë°œ ë‹¨ê³„ì—ì„œëŠ” ìœ ìš©í•˜ì§€ë§Œ, í”„ë¡œë•ì…˜ì—ì„œëŠ” ë„ˆë¬´ ë§ì€ ë¡œê·¸ ë°œìƒ ê°€ëŠ¥

      // ì˜µì…˜ 1: warnë„ ëª¨ë‘ ì „ì†¡ (ê°œë°œ í™˜ê²½ ì¶”ì²œ)
      /*
      window.console.warn = function (...args) {
        originalConsoleWarn.apply(window.console, args);

        const message = args
          .map((arg) => {
            if (typeof arg === "object" && arg !== null) {
              try {
                return JSON.stringify(arg);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");

        sendError({
          type: "console-warn",
          message: message,
          source: "console.warn",
          lineno: 0,
          colno: 0,
          detail: args.length > 0 ? args[0] : null,
        });
      };
      */

      // ì˜µì…˜ 2: ì¤‘ìš”í•œ warnë§Œ í•„í„°ë§í•´ì„œ ì „ì†¡ (í”„ë¡œë•ì…˜ ì¶”ì²œ)
      window.console.warn = function (...args) {
        originalConsoleWarn.apply(window.console, args);

        const message = args
          .map((arg) => {
            if (typeof arg === "object" && arg !== null) {
              try {
                return JSON.stringify(arg);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");

        // ğŸ¯ íŠ¹ì • í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš°ë§Œ ì „ì†¡
        const criticalKeywords = [
          "deprecated",
          "memory",
          "performance",
          "leak",
          "failed",
        ];
        const isCritical = criticalKeywords.some((keyword) =>
          message.toLowerCase().includes(keyword)
        );

        if (isCritical) {
          sendError({
            type: "console-warn-critical",
            message: message,
            source: "console.warn",
            lineno: 0,
            colno: 0,
            detail: args.length > 0 ? args[0] : null,
          });
        }
      };

      // // ğŸ”¥ 6ï¸âƒ£ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ (ì„ íƒì‚¬í•­)
      // window.addEventListener("load", function () {
      //   sendError({
      //     type: "page-load",
      //     message: "Page loaded successfully",
      //     source: window.location.href,
      //     lineno: 0,
      //     colno: 0,
      //   });
      // });

      // ğŸ”¥ 7ï¸âƒ£ SecurityError, CORS ë“± íŠ¹ìˆ˜ ì—ëŸ¬ ê°ì§€
      window.addEventListener("securitypolicyviolation", function (event) {
        sendError({
          type: "security-error",
          message: `CSP violation: ${event.violatedDirective}`,
          source: event.sourceFile || "unknown",
          lineno: event.lineNumber || 0,
          colno: event.columnNumber || 0,
          stack: "N/A",
        });
      });

      // ğŸ”¥ 8ï¸âƒ£ requestAnimationFrame ì—ëŸ¬ ê°ì§€
      // ì°¸ê³ : game.jsì—ì„œ ê²Œì„ ë£¨í”„ë¥¼ try-catchë¡œ ê°ì‹¸ëŠ” ê²ƒ ê¶Œì¥
      const originalRAF = window.requestAnimationFrame;
      // const IS_DEVELOPMENT =
      //   window.location.hostname === "localhost" ||
      //   window.location.hostname === "127.0.0.1";

      window.requestAnimationFrame = function (callback) {
        return originalRAF.call(window, function (time) {
          try {
            callback(time);
          } catch (error) {
            sendError({
              type: "raf-error",
              message: error.message || String(error),
              source: "requestAnimationFrame",
              lineno: 0,
              colno: 0,
              stack: error.stack || "N/A",
            });

            // // ğŸ¯ ê°œë°œ í™˜ê²½ì—ì„œë§Œ ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ ë””ë²„ê¹… ìš©ì´í•˜ê²Œ
            // // í”„ë¡œë•ì…˜ì—ì„œëŠ” ë˜ì§€ì§€ ì•Šì•„ì„œ ì¤‘ë³µ ì „ì†¡ ë°©ì§€
            // if (IS_DEVELOPMENT) {
            //   throw error;
            // }
          }
        });
      };
    </script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/": "https://cdn.jsdelivr.net/npm/three@0.160.0/",
          "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
          "cannon-es": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"
        }
      }
    </script>

    <script type="module" src="game.js"></script>
  </body>
</html>
