<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Alparka!</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png" sizes="32x32">
</head>
<body>
    <h2>알아서 만들어 주는 AI 놀이공원, Alparka!</h2>
    <canvas id="gameCanvas" width="700" height="600" style="display:block; margin:auto;"></canvas>
    
<!-- 
    <script>
    const SERVER_URL = 'http://localhost:8080/client-error'; // 서버 URL 통일

    // 공통 전송 + 콘솔 출력 함수
    function sendError(data) {
        // console.log("error : ",data.type); // type 출력은 디버깅 시에만 사용
        data.game_version = '1.0.1';
        data.time = new Date().toISOString();

        switch (data.type) {
            case 'page-load':
                console.log('%c📥 페이지 접속 완료', 'color: green; font-weight: bold;', data);
                break;
            case 'js-error':
                console.error('%c💥 JS 런타임 에러', 'color: red; font-weight: bold;', data);
                break;
            case 'unhandledrejection':
                console.error('%c⚠️ Promise 비동기 에러', 'color: orange; font-weight: bold;', data);
                break;
            case 'resource-error':
                console.warn('%c🖼️ 리소스 로드 실패', 'color: purple; font-weight: bold;', data);
                break;
            case 'fetch-failed':
                console.error('%c📡 서버 전송 실패', 'color: darkred; font-weight: bold;', data);
                break;
            case 'media-error':
                console.error('%c🔊 미디어 재생 실패', 'color: darkorange; font-weight: bold;', data);
                break;
            case 'game-loop-error':
                console.error('%c🎮 게임 루프 에러', 'color: crimson; font-weight: bold;', data);
                break;
            default:
                console.log('%cℹ️ 기타 이벤트', 'color: blue;', data);
                break;
        }

        // 서버 전송
        fetch(SERVER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).catch(err => {
            console.error('❌ 서버 전송 실패 (fetch catch):', err);
            const failData = {
                type: 'fetch-failed',
                original: data,
                reason: err.message
            };
            // 이 2차 오류는 서버에 보내지 않고 콘솔에만 기록
            console.log('📡 fetch 실패 로그:', failData); 
        });
    }

    // 1️⃣ 페이지 접속 완료
    window.addEventListener('load', () => {
        sendError({ type: 'page-load', message: '페이지 접속 완료' });
    });

    // 2️⃣ JS 런타임 에러
    window.onerror = function(message, source, lineno, colno, error) {
        sendError({
            type: 'js-error',
            message,
            source,
            lineno,
            colno,
            stack: error ? error.stack : 'N/A'
        });
        return false;
    };

    // 3️⃣ Promise 비동기 에러
    window.addEventListener('unhandledrejection', function(event) {
        sendError({
            type: 'unhandledrejection',
            message: event.reason?.message || event.reason,
            stack: event.reason?.stack || 'N/A'
        });
    });

    // 4️⃣ HTML 태그로 로드된 이미지/스크립트/CSS 로드 실패
    window.addEventListener('error', function(event) {
        const target = event.target;
        if (target instanceof HTMLImageElement ||
            target instanceof HTMLScriptElement ||
            target instanceof HTMLLinkElement) {
            sendError({
                type: 'resource-error',
                tag: target.tagName,
                url: target.src || target.href
            });
        }
    }, true);

    // 5️⃣ 동적 이미지 로드 실패 자동 감지
    const originalImage = window.Image;
    window.Image = function() {
        const img = new originalImage();
        const originalOnError = img.onerror;

        img.onerror = function(event) {
            sendError({
                type: 'resource-error',
                tag: 'IMG',
                url: img.src,
                message: '동적 이미지 로드 실패'
            });
            if (originalOnError) originalOnError.call(img, event);
        };

        return img;
    };

    // 6️⃣ 게임 루프 에러 감지 (requestAnimationFrame)
    // 🌟 window에 함수를 할당하여 game.js 모듈에서 접근 가능하도록 함
    window.safeGameLoop = function(loopFunction) {
        function wrappedLoop() {
            try {
                loopFunction();
            } catch(e) {
                sendError({
                    type: 'game-loop-error',
                    message: (e as Error).message, // TypeScript 대응을 위해 명시적으로 타입 캐스팅 (TS 컴파일러가 잡아줌)
                    stack: (e as Error).stack
                });
            }
            requestAnimationFrame(wrappedLoop);
        }
        requestAnimationFrame(wrappedLoop);
    };

    // 7️⃣ 미디어 자동재생 오류 처리
    // 🌟 window에 함수를 할당하여 game.js 모듈에서 접근 가능하도록 함
    window.safePlayMedia = function(mediaElement) {
        try {
            mediaElement.play();
        } catch(e) {
            sendError({
                type: 'media-error',
                message: (e as Error).message,
                stack: (e as Error).stack
            });
        }
    };
    </script> -->




    <script defer>     
        const SERVER_URL = 'http://localhost:8000/client-error'; // ✅ 누락 방지   

// 🌟 1. 원래 함수들을 전역적으로 백업합니다.
        const originalConsoleLog = window.console.log;
        const originalConsoleError = window.console.error;
        const originalConsoleWarn = window.console.warn;

        // 공통 전송 + 콘솔 출력 함수
        function sendError(data) {
            data.game_version = '1.0.1';
            data.time = new Date().toISOString();

            // 🌟 2. switch 문 내부의 console 호출을 백업된 함수로 변경합니다.
            switch (data.type) {
                case 'console-error':
                    originalConsoleError.call(window.console, '%c📥 콘솔 에러', 'color: green; font-weight: bold;', data);
                    break;
                case 'page-load':
                    originalConsoleLog.call(window.console, '%c📥 페이지 접속 완료', 'color: green; font-weight: bold;', data);
                    break;
                case 'js-error':
                    // console.error 대신 originalConsoleError 사용
                    originalConsoleError.call(window.console, '%c💥 JS 런타임 에러', 'color: red; font-weight: bold;', data);
                    break;
                case 'unhandledrejection':
                    originalConsoleError.call(window.console, '%c⚠️ Promise 비동기 에러', 'color: orange; font-weight: bold;', data);
                    break;
                case 'resource-error':
                    // console.warn 대신 originalConsoleWarn 사용
                    originalConsoleWarn.call(window.console, '%c🖼️ 리소스 로드 실패', 'color: purple; font-weight: bold;', data);
                    break;
                case 'fetch-failed':
                    originalConsoleError.call(window.console, '%c📡 서버 전송 실패', 'color: darkred; font-weight: bold;', data);
                    break;
                case 'media-error':
                    originalConsoleError.call(window.console, '%c🔊 미디어 재생 실패', 'color: darkorange; font-weight: bold;', data);
                    break;
                case 'game-loop-error':
                    originalConsoleError.call(window.console, '%c🎮 게임 루프 에러', 'color: crimson; font-weight: bold;', data);
                    break;
                default:
                    originalConsoleLog.call(window.console, '%cℹ️ 기타 이벤트', 'color: blue;', data);
                    break;
            }

            // ... (fetch 호출 로직도 내부의 console.error/log를 백업 함수로 변경해야 합니다.)
            fetch(SERVER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(err => {
                // console.error 대신 originalConsoleError 사용
                originalConsoleError.call(window.console, '❌ 서버 전송 실패 (fetch catch):', err);
                const failData = {
                    type: 'fetch-failed',
                    original: data,
                    reason: err.message
                };
                // console.log 대신 originalConsoleLog 사용
                originalConsoleLog.call(window.console, '📡 fetch 실패 로그:', failData);
            });
        }

        // 2️⃣ JS 런타임 에러
        window.onerror = function(message, source, lineno, colno, error) {
            sendError({
                type: 'js-error',
                message,
                source,
                lineno,
                colno,
                stack: error ? error.stack : 'N/A'
            });
            return false;
        };

        window.console.error = function(...args) {
            // 1. 기존 콘솔 출력 동작 유지
            //originalConsoleError.apply(window.console, args);

            // 2. 서버 전송을 위한 메시지 구성
            const message = args.map(arg => {
                if (typeof arg === 'object' && arg !== null) {
                    return JSON.stringify(arg);
                }
                return String(arg);
            }).join(' ');

            // 3. 서버 전송
            sendError({
                type: 'console-error',
                message: 'Explicit console.error call: ' + message,
                detail: args.length > 0 ? args[0] : null
            });
        };
    </script>

    <script type="module" src="/game.js"></script>
</body>
</html>