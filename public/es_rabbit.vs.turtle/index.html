<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Alparka!</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="assets/favicon.png" sizes="32x32" />
  </head>
  <body>
    <div id="gameContainer">
      <canvas id="gameCanvas" width="1080" height="720"></canvas>
    </div>
    <script defer>
      const SERVER_URL = "http://localhost:8000/client-error";

      // ðŸŒŸ ì›ëž˜ í•¨ìˆ˜ë“¤ì„ ì „ì—­ì ìœ¼ë¡œ ë°±ì—…
      const originalConsoleLog = window.console.log;
      const originalConsoleError = window.console.error;
      const originalConsoleWarn = window.console.warn;

      // ðŸ”¥ ë°°ì¹˜ ìˆ˜ì§‘ ì„¤ì •
      const BATCH_CONFIG = {
        collectionWindow: 5000, // ì²« ì—ëŸ¬ ë°œìƒ í›„ 5ì´ˆ ë™ì•ˆ ìˆ˜ì§‘í•˜ê³  ì „ì†¡
      };

      // ðŸ“¦ ì—ëŸ¬ ìˆ˜ì§‘ ìƒíƒœ
      // [ìˆ˜ì •ë¨] sentErrorHistory: í•œ ë²ˆì´ë¼ë„ ë°œìƒí•œ ì—ëŸ¬ì˜ í‚¤ë¥¼ ì˜êµ¬ ì €ìž¥ (ì¤‘ë³µ ë°©ì§€)
      const sentErrorHistory = new Set();
      let pendingErrors = []; // í˜„ìž¬ ì „ì†¡ ëŒ€ê¸° ì¤‘ì¸ ì—ëŸ¬ ë¦¬ìŠ¤íŠ¸
      let collectionTimer = null; // ìˆ˜ì§‘ ì¢…ë£Œ íƒ€ì´ë¨¸
      let isCollecting = false; // í˜„ìž¬ ìˆ˜ì§‘ ì‚¬ì´í´ì´ ëŒê³  ìžˆëŠ”ì§€ ì—¬ë¶€

      // ðŸ”¥ ì—ëŸ¬ ê³ ìœ  í‚¤ ìƒì„± (ë™ì¼ ì—ëŸ¬ íŒë³„ìš©)
      function getErrorKey(errorData) {
        const { type, message, source, lineno, colno, stack } = errorData;
        // ìŠ¤íƒì˜ ì•žë¶€ë¶„ 5ì¤„ë§Œ ì‚¬ìš©í•˜ì—¬ í•´ì‹œ ìƒì„± (ìš”ì²­ì— ë§žì¶° 5ì¤„ë¡œ ë³€ê²½)
        const stackHash =
          stack && stack !== "N/A"
            ? stack.split("\n").slice(0, 5).join("|")
            : "";
        return `${type}:${message}:${stackHash}`;
      }

      // ðŸ“ ì—ëŸ¬ í•˜ë‚˜ë¥¼ ìš”ì²­í•˜ì‹  ë³´ê³  í˜•ì‹ìœ¼ë¡œ í¬ë§·
      function formatErrorForReport(errorData, index) {
        const { type, message, source, lineno, colno, stack } = errorData;

        // ìœ„ì¹˜ ì •ë³´ (sourceê°€ 'unknown'ì´ë‚˜ 'promise'ê°€ ì•„ë‹ ê²½ìš°ë§Œ í‘œì‹œ)
        const location =
          source && source !== "unknown" && source !== "promise"
            ? `\n\tìœ„ì¹˜: ${source}:${lineno}:${colno}`
            : "";

        // ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ (ìµœëŒ€ 5ì¤„)
        const stackLines = stack && stack !== "N/A" ? stack.split("\n") : [];
        const truncatedStack = stackLines.slice(0, 5).join("\n\t ");
        const stackTrace =
          stackLines.length > 0
            ? `\n\tStack Trace:\n\t${truncatedStack}\n... (Full stack trace truncated)`
            : "";

        return `${index + 1}. [${type}] ${message}${location}${stackTrace}`;
      }

      // ðŸ“¤ ìˆ˜ì§‘ ì™„ë£Œ í›„ ì „ì†¡
      function sendCollectedErrors() {
        if (pendingErrors.length === 0) {
          isCollecting = false;
          collectionTimer = null;
          return;
        }

        // ì „ì†¡í•  ëª©ë¡ ë³µì‚¬
        const errorsToSend = [...pendingErrors];

        // ëŒ€ê¸° ëª©ë¡ë§Œ ì´ˆê¸°í™”
        pendingErrors = [];
        isCollecting = false;
        collectionTimer = null;

        // ðŸ“Š ìµœì¢… ë³´ê³ ì„œ ë¬¸ìžì—´ ìƒì„±
        const errorReportBody = errorsToSend
          .map((error, index) => formatErrorForReport(error, index))
          .join("\n\n");

        const header = `==================================================
ëŸ°íƒ€ìž„ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!: ${errorsToSend.length}ê°œ ì—ëŸ¬
==================================================`;

        const finalReport = `${header}\n\n${errorReportBody}`;

        // ðŸ“¦ ì „ì†¡ ë°ì´í„° êµ¬ì¡° ë³€ê²½ (report ë¬¸ìžì—´ í¬í•¨)
        const batchData = {
          type: "error-batch",
          game_version: "1.0.1",
          collected_at: new Date().toISOString(),
          error_count: errorsToSend.length,
          // ìš”ì²­í•˜ì‹  ë‹¨ì¼ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì „ì†¡
          error_report: finalReport,
          // ì›ë³¸ ì—ëŸ¬ ëª©ë¡ë„ ë””ë²„ê¹…ìš©ìœ¼ë¡œ ìœ ì§€
          errors: errorsToSend,
        };

        originalConsoleLog.call(
          window.console,
          `%cðŸ“¦ ì—ëŸ¬ ìˆ˜ì§‘ ì™„ë£Œ - ${errorsToSend.length}ê±´ ì „ì†¡ (ì¤‘ë³µ ì œì™¸ë¨)`,
          "color: blue; font-weight: bold; font-size: 14px;",
          batchData
        );
        originalConsoleLog.call(window.console, finalReport); // ì½˜ì†”ì— ìµœì¢… ë³´ê³ ì„œ ì¶œë ¥

        // 1. ë¶€ëª¨ íŽ˜ì´ì§€ë¡œ ì „ì†¡ (payloadì— finalReport í¬í•¨)
        try {
          window.parent.postMessage(
            {
              source: "alparka-game-iframe",
              type: "error-batch",
              // ìš”ì²­í•˜ì‹  í˜•ì‹ì˜ ë¬¸ìžì—´ì„ ì§ì ‘ ì „ì†¡
              payload: {
                error_report: finalReport,
                error_count: errorsToSend.length,
              },
            },
            "*"
          );

          originalConsoleWarn.call(
            window.console,
            "ë¶€ëª¨ ì°½ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ!!:"
          );
        } catch (e) {
          originalConsoleWarn.call(
            window.console,
            "ðŸš¨ ë¶€ëª¨ ì°½ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:",
            e
          );
        }

        // // 2. ì„œë²„ ì „ì†¡
        // fetch(SERVER_URL, {
        //   method: "POST",
        //   headers: { "Content-Type": "application/json" },
        //   body: JSON.stringify(batchData),
        // }).catch((err) => {
        //   originalConsoleError.call(window.console, "âŒ ë°°ì¹˜ ì „ì†¡ ì‹¤íŒ¨:", err);
        // });
      }

      // ðŸ“ ì—ëŸ¬ ìˆ˜ì§‘ í•¨ìˆ˜ (ë‚˜ë¨¸ì§€ëŠ” ë™ì¼)
      function collectError(data) {
        data.time = new Date().toISOString();
        data.game_version = "1.0.1";

        const errorKey = getErrorKey(data);

        // [ìˆ˜ì •ë¨] ì´ì „ì— í•œ ë²ˆì´ë¼ë„ ë°œìƒí–ˆë˜ ì—ëŸ¬ì¸ì§€ í™•ì¸
        if (sentErrorHistory.has(errorKey)) {
          /*
          originalConsoleLog.call(
            window.console,
            `%cðŸ”„ ì´ë¯¸ ì „ì†¡ëœ ì—ëŸ¬ ë¬´ì‹œ: ${data.message}`,
            "color: gray; font-size: 10px;"
          );
          */
          return;
        }

        // ìƒˆë¡œìš´ ì¢…ë¥˜ì˜ ì—ëŸ¬ìž„!
        sentErrorHistory.add(errorKey); // ì˜êµ¬ ê¸°ë¡ì— ì¶”ê°€
        pendingErrors.push(data); // ì´ë²ˆ ì „ì†¡ ëŒ€ê¸°ì—´ì— ì¶”ê°€

        // íƒ€ìž…ë³„ ì½˜ì†” ì¶œë ¥ (ìµœì´ˆ 1íšŒë§Œ ì¶œë ¥ë¨)
        const style = "color: orange; font-weight: bold;";
        originalConsoleLog.call(
          window.console,
          `%cðŸ†• ìƒˆ ì—ëŸ¬ ê°ì§€: ${data.message}`,
          style
        );

        // ðŸŽ¯ ìˆ˜ì§‘ íƒ€ì´ë¨¸ê°€ ì•ˆ ëŒê³  ìžˆë‹¤ë©´ ì‹œìž‘ (ì²« ì—ëŸ¬ ë°œìƒ ì‹œì )
        if (!isCollecting) {
          isCollecting = true;
          originalConsoleLog.call(
            window.console,
            `%câ±ï¸ ë°°ì¹˜ ìˆ˜ì§‘ ì‹œìž‘ (${
              BATCH_CONFIG.collectionWindow / 1000
            }ì´ˆ ë’¤ ì „ì†¡)`,
            "color: green;"
          );

          collectionTimer = setTimeout(() => {
            sendCollectedErrors();
          }, BATCH_CONFIG.collectionWindow);
        }
      }

      // --- ê¸°ì¡´ì˜ window.onerror, unhandledrejection, error, console.error/warn ì˜¤ë²„ë¼ì´ë“œëŠ” ë™ì¼í•˜ê²Œ ìœ ì§€ ---

      // ðŸ”¥ JS ëŸ°íƒ€ìž„ ì—ëŸ¬
      window.onerror = function (message, source, lineno, colno, error) {
        collectError({
          type: "js-error",
          message: String(message),
          source: source || "unknown",
          lineno: lineno || 0,
          colno: colno || 0,
          stack: error ? error.stack : "N/A",
        });
        return false;
      };

      // ðŸ”¥ Promise rejection ì—ëŸ¬
      window.addEventListener("unhandledrejection", function (event) {
        collectError({
          type: "unhandledrejection",
          message: event.reason ? String(event.reason) : "Promise rejected",
          source: "promise",
          lineno: 0,
          colno: 0,
          stack:
            event.reason && event.reason.stack ? event.reason.stack : "N/A",
        });
      });

      // ðŸ”¥ ë¦¬ì†ŒìŠ¤ ë¡œë“œ ì—ëŸ¬
      window.addEventListener(
        "error",
        function (event) {
          if (event.target !== window) {
            collectError({
              type: "resource-error",
              message: `Failed to load: ${event.target.tagName}`,
              source: event.target.src || event.target.href || "unknown",
              lineno: 0,
              colno: 0,
              stack: "N/A",
            });
          }
        },
        true
      );

      // ðŸ”¥ console.error ì˜¤ë²„ë¼ì´ë“œ
      window.console.error = function (...args) {
        originalConsoleError.apply(window.console, args);
        const message = args.map((arg) => String(arg)).join(" ");
        collectError({
          type: "console-error",
          message: message,
          source: "console.error",
          lineno: 0,
          colno: 0,
          stack: "N/A",
        });
      };

      // ðŸ”¥ console.warn ì˜¤ë²„ë¼ì´ë“œ
      window.console.warn = function (...args) {
        originalConsoleWarn.apply(window.console, args);
        const message = args.map((arg) => String(arg)).join(" ");
        const criticalKeywords = [
          "deprecated",
          "memory",
          "performance",
          "leak",
          "failed",
        ];
        if (criticalKeywords.some((k) => message.toLowerCase().includes(k))) {
          collectError({
            type: "console-warn-critical",
            message: message,
            source: "console.warn",
            lineno: 0,
            colno: 0,
            stack: "N/A",
          });
        }
      };

      // ðŸšª íŽ˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ë‚¨ì€ ì—ëŸ¬ ì „ì†¡ (sendBeacon)
      window.addEventListener("beforeunload", function () {
        if (pendingErrors.length > 0) {
          const errorReportBody = pendingErrors
            .map((error, index) => formatErrorForReport(error, index))
            .join("\n\n");

          const header = `==================================================
ëŸ°íƒ€ìž„ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!: ${pendingErrors.length}ê°œ ì—ëŸ¬
==================================================`;

          const finalReport = `${header}\n\n${errorReportBody}`;

          const batchData = {
            type: "error-batch-final",
            game_version: "1.0.1",
            collected_at: new Date().toISOString(),
            error_count: pendingErrors.length,
            // sendBeaconì—ë„ ë³´ê³ ì„œ í˜•ì‹ í¬í•¨
            error_report: finalReport,
            errors: pendingErrors,
          };
          // sendBeaconì€ í…ìŠ¤íŠ¸/ë°ì´í„°ë§Œ ì „ì†¡í•˜ë¯€ë¡œ JSON.stringifyë¥¼ ì‚¬ìš©
          navigator.sendBeacon(SERVER_URL, JSON.stringify(batchData));
        }
      });

      document.addEventListener("visibilitychange", function () {
        if (document.hidden && pendingErrors.length > 0) {
          sendCollectedErrors();
        }
      });
    </script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/": "https://cdn.jsdelivr.net/npm/three@0.160.0/",
          "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
          "cannon-es": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"
        }
      }
    </script>

    <script type="module" src="game.js"></script>
  </body>
</html>
