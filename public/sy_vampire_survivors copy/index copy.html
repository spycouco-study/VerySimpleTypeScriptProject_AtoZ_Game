<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Alparka!</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="favicon.png" sizes="32x32" />
  </head>
  <body>
    <div id="gameContainer">
      <h2>ì•Œì•„ì„œ ë§Œë“¤ì–´ ì£¼ëŠ” AI ë†€ì´ê³µì›, Alparka!</h2>
      <canvas id="gameCanvas" width="1080" height="720"></canvas>
    </div>
    <script defer>
      const SERVER_URL = "http://localhost:8000/client-error"; // âœ… ëˆ„ë½ ë°©ì§€

      // ğŸŒŸ 1. ì›ë˜ í•¨ìˆ˜ë“¤ì„ ì „ì—­ì ìœ¼ë¡œ ë°±ì—…í•©ë‹ˆë‹¤.
      const originalConsoleLog = window.console.log;
      const originalConsoleError = window.console.error;
      const originalConsoleWarn = window.console.warn;

      // ê³µí†µ ì „ì†¡ + ì½˜ì†” ì¶œë ¥ í•¨ìˆ˜
      function sendError(data) {
        data.game_version = "1.0.1";
        data.time = new Date().toISOString();

        // ğŸŒŸ [ì¶”ê°€] 1. ë¶€ëª¨ í˜ì´ì§€ë¡œ ì˜¤ë¥˜ ë°ì´í„° ì „ë‹¬ (postMessage) ğŸŒŸ
        // 'ì•ŒíŒŒì¹´ ê²Œì„ì—ì„œ ì˜¤ë¥˜ ë°œìƒ'ì´ë¼ëŠ” ë©”ì‹œì§€ íƒ€ì…ì„ ì¶”ê°€í•˜ì—¬ ì „ë‹¬í•©ë‹ˆë‹¤.
        try {
          window.parent.postMessage(
            {
              source: "alparka-game-iframe",
              type: "error-report",
              payload: data,
            },
            "*"
          ); // '*'ëŠ” ëª¨ë“  ì¶œì²˜ì— ë©”ì‹œì§€ë¥¼ ë³´ëƒ„ (ë³´ì•ˆì— ì‹ ê²½ ì“´ë‹¤ë©´ íŠ¹ì • ì¶œì²˜ ëª…ì‹œ)
        } catch (e) {
          // postMessage ì‹¤íŒ¨ ì‹œ (ì˜ˆ: ë¶€ëª¨ ì°½ì´ ë‹«í˜”ê±°ë‚˜ ë³´ì•ˆ ì˜¤ë¥˜ ë“±)
          originalConsoleWarn.call(
            window.console,
            "ğŸš¨ ë¶€ëª¨ ì°½ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:",
            e
          );
        }

        // ğŸŒŸ 2. switch ë¬¸ ë‚´ë¶€ì˜ console í˜¸ì¶œì„ ë°±ì—…ëœ í•¨ìˆ˜ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        switch (data.type) {
          case "console-error":
            originalConsoleError.call(
              window.console,
              "%cğŸ“¥ ì½˜ì†” ì—ëŸ¬",
              "color: green; font-weight: bold;",
              data
            );
            break;
          case "page-load":
            originalConsoleLog.call(
              window.console,
              "%cğŸ“¥ í˜ì´ì§€ ì ‘ì† ì™„ë£Œ",
              "color: green; font-weight: bold;",
              data
            );
            break;
          case "js-error":
            // console.error ëŒ€ì‹  originalConsoleError ì‚¬ìš©
            originalConsoleError.call(
              window.console,
              "%cğŸ’¥ JS ëŸ°íƒ€ì„ ì—ëŸ¬",
              "color: red; font-weight: bold;",
              data
            );
            break;
          case "unhandledrejection":
            originalConsoleError.call(
              window.console,
              "%câš ï¸ Promise ë¹„ë™ê¸° ì—ëŸ¬",
              "color: orange; font-weight: bold;",
              data
            );
            break;
          case "resource-error":
            // console.warn ëŒ€ì‹  originalConsoleWarn ì‚¬ìš©
            originalConsoleWarn.call(
              window.console,
              "%cğŸ–¼ï¸ ë¦¬ì†ŒìŠ¤ ë¡œë“œ ì‹¤íŒ¨",
              "color: purple; font-weight: bold;",
              data
            );
            break;
          case "fetch-failed":
            originalConsoleError.call(
              window.console,
              "%cğŸ“¡ ì„œë²„ ì „ì†¡ ì‹¤íŒ¨",
              "color: darkred; font-weight: bold;",
              data
            );
            break;
          case "media-error":
            originalConsoleError.call(
              window.console,
              "%cğŸ”Š ë¯¸ë””ì–´ ì¬ìƒ ì‹¤íŒ¨",
              "color: darkorange; font-weight: bold;",
              data
            );
            break;
          case "game-loop-error":
            originalConsoleError.call(
              window.console,
              "%cğŸ® ê²Œì„ ë£¨í”„ ì—ëŸ¬",
              "color: crimson; font-weight: bold;",
              data
            );
            break;
          default:
            originalConsoleLog.call(
              window.console,
              "%câ„¹ï¸ ê¸°íƒ€ ì´ë²¤íŠ¸",
              "color: blue;",
              data
            );
            break;
        }

        // ... (fetch í˜¸ì¶œ ë¡œì§ë„ ë‚´ë¶€ì˜ console.error/logë¥¼ ë°±ì—… í•¨ìˆ˜ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.)
        fetch(SERVER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        }).catch((err) => {
          // console.error ëŒ€ì‹  originalConsoleError ì‚¬ìš©
          originalConsoleError.call(
            window.console,
            "âŒ ì„œë²„ ì „ì†¡ ì‹¤íŒ¨ (fetch catch):",
            err
          );
          const failData = {
            type: "fetch-failed",
            original: data,
            reason: err.message,
          };
          // console.log ëŒ€ì‹  originalConsoleLog ì‚¬ìš©
          originalConsoleLog.call(
            window.console,
            "ğŸ“¡ fetch ì‹¤íŒ¨ ë¡œê·¸:",
            failData
          );
        });
      }

      // 2ï¸âƒ£ JS ëŸ°íƒ€ì„ ì—ëŸ¬
      window.onerror = function (message, source, lineno, colno, error) {
        sendError({
          type: "js-error",
          message,
          source,
          lineno,
          colno,
          stack: error ? error.stack : "N/A",
        });
        return false;
      };

      window.console.error = function (...args) {
        // 1. ê¸°ì¡´ ì½˜ì†” ì¶œë ¥ ë™ì‘ ìœ ì§€
        originalConsoleError.apply(window.console, args);

        // 2. ì„œë²„ ì „ì†¡ì„ ìœ„í•œ ë©”ì‹œì§€ êµ¬ì„±
        const message = args
          .map((arg) => {
            if (typeof arg === "object" && arg !== null) {
              return JSON.stringify(arg);
            }
            return String(arg);
          })
          .join(" ");

        // 3. ì„œë²„ ì „ì†¡
        sendError({
          type: "console-error",
          message: "Explicit console.error call: " + message,
          detail: args.length > 0 ? args[0] : null,
        });
      };
    </script>

    <script type="module" src="game.js"></script>
  </body>
</html>
