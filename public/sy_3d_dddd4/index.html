<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Alparka!</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="favicon.png" sizes="32x32" />
  </head>
  <body>
    <div id="gameContainer">
      <h2>ì•Œì•„ì„œ ë§Œë“¤ì–´ ì£¼ëŠ” AI ë†€ì´ê³µì›, Alparka!</h2>
      <canvas id="gameCanvas" width="1080" height="720"></canvas>
    </div>
    <script defer>
      const SERVER_URL = "http://localhost:8000/client-error";

      // ğŸŒŸ ì›ë˜ í•¨ìˆ˜ë“¤ì„ ì „ì—­ì ìœ¼ë¡œ ë°±ì—…
      const originalConsoleLog = window.console.log;
      const originalConsoleError = window.console.error;
      const originalConsoleWarn = window.console.warn;

      // ğŸ”¥ ë°°ì¹˜ ìˆ˜ì§‘ ì„¤ì •
      const BATCH_CONFIG = {
        collectionWindow: 5000, // ì²« ì—ëŸ¬ í›„ 5ì´ˆ ë™ì•ˆë§Œ ìˆ˜ì§‘
      };

      // ğŸ“¦ ì—ëŸ¬ ìˆ˜ì§‘ ìƒíƒœ
      let errorSet = new Set(); // ì¤‘ë³µ ì œê±°ìš© (errorKey ì €ì¥)
      let errorList = []; // ì‹¤ì œ ì—ëŸ¬ ë°ì´í„° ì €ì¥
      let collectionTimer = null; // ìˆ˜ì§‘ ì¢…ë£Œ íƒ€ì´ë¨¸
      let isCollecting = false; // ìˆ˜ì§‘ ì¤‘ì¸ì§€ ì—¬ë¶€

      // ğŸ”¥ ì—ëŸ¬ ê³ ìœ  í‚¤ ìƒì„± (ë™ì¼ ì—ëŸ¬ íŒë³„ìš©)
      function getErrorKey(errorData) {
        const { type, message, source, lineno, colno, stack } = errorData;
        const stackHash =
          stack && stack !== "N/A"
            ? stack.split("\n").slice(0, 3).join("|")
            : "";
        return `${type}:${message}:${stackHash}`;
      }

      // ğŸ“¤ ìˆ˜ì§‘ ì™„ë£Œ í›„ ì „ì†¡
      function sendCollectedErrors() {
        if (errorList.length === 0) return;

        const errorsToSend = [...errorList];

        // ìƒíƒœ ì´ˆê¸°í™”
        errorSet.clear();
        errorList = [];
        isCollecting = false;
        collectionTimer = null;

        // ë°°ì¹˜ ë°ì´í„° ìƒì„±
        const batchData = {
          type: "error-batch",
          game_version: "1.0.1",
          collected_at: new Date().toISOString(),
          error_count: errorsToSend.length,
          errors: errorsToSend,
        };

        originalConsoleLog.call(
          window.console,
          `%cğŸ“¦ ì—ëŸ¬ ìˆ˜ì§‘ ì™„ë£Œ - ${errorsToSend.length}ì¢…ë¥˜ ì „ì†¡`,
          "color: blue; font-weight: bold; font-size: 14px;",
          batchData
        );

        // ë¶€ëª¨ í˜ì´ì§€ë¡œ ì „ì†¡
        try {
          window.parent.postMessage(
            {
              source: "alparka-game-iframe",
              type: "error-batch",
              payload: batchData,
            },
            "*"
          );
        } catch (e) {
          originalConsoleWarn.call(
            window.console,
            "ğŸš¨ ë¶€ëª¨ ì°½ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:",
            e
          );
        }

        // ì„œë²„ ì „ì†¡
        fetch(SERVER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(batchData),
        }).catch((err) => {
          originalConsoleError.call(window.console, "âŒ ë°°ì¹˜ ì „ì†¡ ì‹¤íŒ¨:", err);
        });
      }

      // ğŸ“ ì—ëŸ¬ ìˆ˜ì§‘
      function collectError(data) {
        data.time = new Date().toISOString();
        data.game_version = "1.0.1";

        const errorKey = getErrorKey(data);

        // ì´ë¯¸ ìˆ˜ì§‘ëœ ì—ëŸ¬ì¸ì§€ í™•ì¸
        if (errorSet.has(errorKey)) {
          originalConsoleLog.call(
            window.console,
            `%cğŸ”„ ì¤‘ë³µ ì—ëŸ¬ ë¬´ì‹œ [ìˆ˜ì§‘ ì¤‘: ${errorList.length}ì¢…ë¥˜]`,
            "color: gray; font-style: italic;",
            data.message
          );
          return;
        }

        // ìƒˆë¡œìš´ ì—ëŸ¬ ì¶”ê°€
        errorSet.add(errorKey);
        errorList.push(data);

        // íƒ€ì…ë³„ ì½˜ì†” ì¶œë ¥
        const style = "color: orange; font-weight: bold;";
        switch (data.type) {
          case "console-error":
            originalConsoleError.call(
              window.console,
              `%cğŸ“¥ ì½˜ì†” ì—ëŸ¬ ìˆ˜ì§‘ [${errorList.length}ì¢…ë¥˜]`,
              style,
              data.message
            );
            break;
          case "js-error":
            originalConsoleError.call(
              window.console,
              `%cğŸ’¥ JS ì—ëŸ¬ ìˆ˜ì§‘ [${errorList.length}ì¢…ë¥˜]`,
              style,
              data.message
            );
            break;
          case "unhandledrejection":
            originalConsoleError.call(
              window.console,
              `%câš ï¸ Promise ì—ëŸ¬ ìˆ˜ì§‘ [${errorList.length}ì¢…ë¥˜]`,
              style,
              data.message
            );
            break;
          default:
            originalConsoleLog.call(
              window.console,
              `%câ„¹ï¸ ${data.type} ìˆ˜ì§‘ [${errorList.length}ì¢…ë¥˜]`,
              style,
              data.message
            );
        }

        // ğŸ¯ ì²« ë²ˆì§¸ ì—ëŸ¬ì¼ ê²½ìš° ìˆ˜ì§‘ ì‹œì‘
        if (!isCollecting) {
          isCollecting = true;
          originalConsoleLog.call(
            window.console,
            `%câ±ï¸ ì—ëŸ¬ ìˆ˜ì§‘ ì‹œì‘ - ${
              BATCH_CONFIG.collectionWindow / 1000
            }ì´ˆ í›„ ì „ì†¡`,
            "color: green; font-weight: bold;"
          );

          collectionTimer = setTimeout(() => {
            sendCollectedErrors();
          }, BATCH_CONFIG.collectionWindow);
        }
      }

      // ğŸ”¥ JS ëŸ°íƒ€ì„ ì—ëŸ¬
      window.onerror = function (message, source, lineno, colno, error) {
        collectError({
          type: "js-error",
          message: String(message),
          source: source || "unknown",
          lineno: lineno || 0,
          colno: colno || 0,
          stack: error ? error.stack : "N/A",
        });
        return false;
      };

      // ğŸ”¥ Promise rejection ì—ëŸ¬
      window.addEventListener("unhandledrejection", function (event) {
        collectError({
          type: "unhandledrejection",
          message: event.reason ? String(event.reason) : "Promise rejected",
          source: "promise",
          lineno: 0,
          colno: 0,
          stack:
            event.reason && event.reason.stack ? event.reason.stack : "N/A",
        });
      });

      // ğŸ”¥ ë¦¬ì†ŒìŠ¤ ë¡œë“œ ì—ëŸ¬
      window.addEventListener(
        "error",
        function (event) {
          if (event.target !== window) {
            collectError({
              type: "resource-error",
              message: `Failed to load: ${event.target.tagName}`,
              source: event.target.src || event.target.href || "unknown",
              lineno: 0,
              colno: 0,
              stack: "N/A",
            });
          }
        },
        true
      );

      // ğŸ”¥ console.error ì˜¤ë²„ë¼ì´ë“œ
      window.console.error = function (...args) {
        originalConsoleError.apply(window.console, args);

        const message = args
          .map((arg) => {
            if (typeof arg === "object" && arg !== null) {
              try {
                return JSON.stringify(arg);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");

        collectError({
          type: "console-error",
          message: message,
          source: "console.error",
          lineno: 0,
          colno: 0,
          stack: "N/A",
        });
      };

      // ğŸ”¥ console.warn ì˜¤ë²„ë¼ì´ë“œ (ì¤‘ìš”í•œ ê²ƒë§Œ)
      window.console.warn = function (...args) {
        originalConsoleWarn.apply(window.console, args);

        const message = args
          .map((arg) => {
            if (typeof arg === "object" && arg !== null) {
              try {
                return JSON.stringify(arg);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");

        const criticalKeywords = [
          "deprecated",
          "memory",
          "performance",
          "leak",
          "failed",
        ];
        const isCritical = criticalKeywords.some((keyword) =>
          message.toLowerCase().includes(keyword)
        );

        if (isCritical) {
          collectError({
            type: "console-warn-critical",
            message: message,
            source: "console.warn",
            lineno: 0,
            colno: 0,
            stack: "N/A",
          });
        }
      };

      // ğŸ”¥ SecurityError ê°ì§€
      window.addEventListener("securitypolicyviolation", function (event) {
        collectError({
          type: "security-error",
          message: `CSP violation: ${event.violatedDirective}`,
          source: event.sourceFile || "unknown",
          lineno: event.lineNumber || 0,
          colno: event.columnNumber || 0,
          stack: "N/A",
        });
      });

      // ğŸ”¥ requestAnimationFrame ì—ëŸ¬ ê°ì§€
      const originalRAF = window.requestAnimationFrame;

      window.requestAnimationFrame = function (callback) {
        return originalRAF.call(window, function (time) {
          try {
            callback(time);
          } catch (error) {
            collectError({
              type: "raf-error",
              message: error.message || String(error),
              source: "requestAnimationFrame",
              lineno: 0,
              colno: 0,
              stack: error.stack || "N/A",
            });
          }
        });
      };

      // ğŸšª í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ë‚¨ì€ ì—ëŸ¬ ì „ì†¡
      window.addEventListener("beforeunload", function () {
        if (errorList.length > 0) {
          const batchData = {
            type: "error-batch-final",
            game_version: "1.0.1",
            collected_at: new Date().toISOString(),
            error_count: errorList.length,
            errors: errorList,
          };

          navigator.sendBeacon(SERVER_URL, JSON.stringify(batchData));
        }
      });

      // ğŸ¯ í˜ì´ì§€ ìˆ¨ê¹€ ì‹œì—ë„ ì „ì†¡ (ëª¨ë°”ì¼ ëŒ€ì‘)
      document.addEventListener("visibilitychange", function () {
        if (document.hidden && errorList.length > 0) {
          sendCollectedErrors();
        }
      });
    </script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/": "https://cdn.jsdelivr.net/npm/three@0.160.0/",
          "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
          "cannon-es": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"
        }
      }
    </script>

    <script type="module" src="game.js"></script>
  </body>
</html>
